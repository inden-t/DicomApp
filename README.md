# DICOM App

（このアプリケーションは開発者の学習と技術向上を目的として作成されました。実際の医療診断や臨床使用を意図したものではありません。）

DICOM Appは、DICOM（Digital Imaging and Communications in Medicine）形式の医療画像ファイルを閲覧・操作するためのWindowsデスクトップアプリケーションです。

## 機能

### 2D画像表示機能
- DICOM画像ファイルの読み込みと表示
- スライスの移動
- 画像のズームイン/ズームアウト
- 画像のパン（移動）

### 3Dモデル表示機能
- 高輝度領域の3D再構成
  - 主に骨構造や造影剤で強調された血管構造が3次元的に表示されます
- 表示方法
  - 点群表示
  - サーフェスモデル表示
    - マーチングキューブ法による生成
    - 線形補間オプション（あり/なし）
- 3Dモデル操作
  - 回転
  - ズーム
  - パン（上下左右の移動）
  - ドリー（前後の移動）
- 3Dモデルの保存と読み込み
  - OBJファイル形式でのモデル保存
  - 保存したOBJファイルの読み込みと表示

### 血管抽出機能
- 2D/3D塗りつぶし選択
- 選択範囲の保存と読み込み
- 選択の元に戻す/やり直し（Undo/Redo）
- 選択範囲の3Dサーフェスモデル生成
- 血管抽出のしきい値の調整
  - 塗りつぶし選択の境界の輝度を設定
  - 下限しきい値と上限しきい値を設定可能
  - 0-255（黒～白）の範囲で調整可能
  - しきい値はモデリングの線形補間の計算にも使用
- 血管に限らず、選択した任意の範囲をモデリング可能

## セットアップ

1. リポジトリをクローンします。
2. Visual Studioでソリューションを開きます。
3. 必要なNuGetパッケージを復元します。
4. プロジェクトをビルドし、実行します。

## 使用方法

### 準備
- DICOMファイルを用意します。テスト用のDICOMファイルは医療画像データベースなどから入手できます。
- 3Dモデルを表示する場合は、CTやMRIなどの断層撮影画像のDICOMファイルを用意してください。血管構造を表示したい場合は、造影剤を使用した画像を用意してください。

### 2D画像表示
1. アプリケーションを起動します。
2. DICOM画像ファイルを含むフォルダを選択し、ファイルを読み込みます。（フォルダ内の全てのDICOMファイルが読み込まれます）
3. ファイルを読み込まなかった場合は "ファイル" メニューから "ファイルを開く..." または "フォルダーを開く..." を選択し、DICOM画像ファイルを読み込みます。
   - "ファイルを開く..." ではファイルを複数選択して開くことができます。
4. 左側のリストビューで表示したい画像を選択します。
5. 画像表示エリアで以下の操作が可能です：
   - マウスホイール: スライスの移動（前後の画像に切り替え）
   - Ctrlキー + マウスホイール: ズームイン/ズームアウト
   - マウス中ボタンドラッグ: 画像のパン（移動）

### 3Dモデル表示
1. 2D画像表示の手順に従って、DICOMファイルを読み込みます。
2. メニューの "点群表示" または "サーフェスモデル表示" または "サーフェスモデル表示(線形補間)" をクリックすると、3Dモデルが表示されます。
   - 注意："点群表示" をクリックした場合、処理に時間がかかり、動作が非常に遅くなる可能性があります。パフォーマンスを向上させるため、開くファイル数を数個程度にすることをお勧めします。
3. 3Dモデル表示ウィンドウでは以下の操作が可能です：
   - マウス左ボタンドラッグ: 回転
   - マウスホイール: ズームイン/ズームアウト
   - マウス中ボタンドラッグ: 上下左右の移動
   - Shiftキー + マウスホイール: 前後の移動

3Dビューワーの中央には黄色い点が表示され、回転の中心を示します。

### 血管抽出
1. 2D画像表示の手順に従って、DICOMファイルを読み込みます。
2. 血管抽出のしきい値を調整します：
   - 下限しきい値と上限しきい値を設定します（0-255の範囲）。
   - これらのしきい値は、選択される画素の輝度範囲を決定します。
   - 例えば、造影剤で強調された血管を抽出する場合、高い輝度範囲（例：220-255）を設定します。
3. "血管抽出開始" ボタンをクリックして、血管抽出モードに入ります。
4. 血管抽出タブで以下の操作が可能です：
   - 3D/2D塗りつぶし選択: 画像上でクリックして領域を選択
     - 3D選択：クリックした点を含む3D空間内の連続したしきい値内の領域を選択します。
     - 2D選択：クリックしたスライス内の連続したしきい値内の領域を選択します。
   - 3D/2D塗りつぶし選択解除: 選択した領域を解除
   - 選択範囲の保存/読み込み: 選択した領域をファイルに保存または読み込み
   - 元に戻す/やり直し: 選択操作の元に戻す/やり直し
   - サーフェスモデル生成: 選択した領域の3Dサーフェスモデルを生成

※ 選択範囲の保存と読み込みの注意点：
  - 選択範囲を読み込む前に、必ず保存時に開いていたDICOMファイル群を開いてください。
  - 選択範囲のモデリングにはDICOMイメージの輝度情報も使用するため、異なるDICOMファイル群が開かれている状態で選択範囲を読み込むと、正しくモデリングされない可能性があります。

### 3Dモデルの保存と読み込み
1. 3Dモデル表示ウィンドウで、"モデルを保存..." ボタンをクリックします。
2. 保存先とファイル名を指定して、モデルをOBJ形式で保存します。
3. 保存したモデルを読み込むには、メインウィンドウの "モデルを読み込む..." ボタンをクリックします。
4. 保存したOBJファイルを選択すると、3Dモデルビューワーで表示されます。

## 技術仕様

### 開発環境
- 言語: C#
- フレームワーク: WPF (Windows Presentation Foundation)
- .NET バージョン: .NET 8.0

### 主要ライブラリ
- fo-dicom: DICOMファイルの読み込みと操作
- ReactiveProperty: リアクティブプログラミングのサポート
- Prism.Wpf: MVVMパターンの実装サポート

### アプリケーション構成
- `Views`: ユーザーインターフェース
- `ViewModels`: ビューとモデルを橋渡しするビューモデル
- `UseCases`: アプリケーションの主要な機能を実装するユースケース
- `Models`: データモデルとビジネスロジック
- `Presenters`: ユースケースとビューモデルを橋渡しするプレゼンター
- `PresenterInterface`: プレゼンターのインターフェース

### 主要コンポーネント
- `App.xaml.cs`: アプリケーションのエントリーポイントとDI（依存性注入）の設定
- `MainWindowViewModel.cs`: メインウィンドウの主要なロジックを管理
- `ImageViewerViewModel.cs`: 画像表示に関するロジックを管理
- `Model3dViewer.xaml.cs`: 3Dモデルの表示と操作に関するロジックを実装
- `GeneratePointCloudUseCase.cs`: 点群モデル生成のロジックを実装
- `GenerateSurfaceModelUseCase.cs`: サーフェスモデル生成のロジックを実装
- `GenerateSurfaceModelWithLinearInterpolationUseCase.cs`: サーフェスモデル生成のロジックに線形補間を追加したものを実装
- `BloodVesselExtractionUseCase.cs`: 血管抽出機能のロジックを実装
- `Select3DBloodVesselRegionUseCase.cs`: 3D領域選択のロジックを実装
- `SaveModel3dUseCase.cs`: 3Dモデルの保存機能を実装
- `LoadModel3dUseCase.cs`: 保存した3Dモデルの読み込み機能を実装

## 注意事項

このアプリケーションは開発者の学習目的で開発されたものであり、実際の医療診断や臨床使用を意図したものではありません。医療目的での使用は推奨されません。開発者は、このアプリケーションの使用によって生じるいかなる損害や問題に対しても責任を負いません。

使用者は、このアプリケーションを使用する前に、適用される法律、規制、およびプライバシーポリシーを確認し、遵守する責任があります。また、DICOMファイルに含まれる個人情報やセンシティブな医療情報の取り扱いには十分注意してください。
