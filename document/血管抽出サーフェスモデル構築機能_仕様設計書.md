# 血管抽出サーフェスモデル構築機能 仕様書

## 1. 仕様

### 1.1 概要
この機能は、ユーザーが手動で血管領域を指定し、その領域のみを抽出してサーフェスモデルを構築するものです。これにより、より正確な血管の3Dモデルを生成することが可能になります。

### 1.2 機能要件
1. 血管領域の指定
   - ユーザーは2D画像上で血管領域を多角形で指定できる
   - 複数のスライスで領域を指定可能
   - 指定した領域は保存・編集可能

2. 血管抽出処理
   - 指定された領域内のみでサーフェスモデルを生成
   - マーチングキューブ法を使用してモデルを構築
   - 線形補間を使用してモデルを構築

3. モデル表示
   - 生成されたモデルを3Dビューワーで表示
   - 回転、ズーム、パンなどの操作が可能

### 1.3 ユーザーインターフェース要件
1. 血管領域指定ツール
   - 2D画像ビューワーに多角形描画ツールを追加
   - 描画した領域の編集・削除機能
   - スライス間での領域のコピー機能

2. 抽出設定ダイアログ
   - しきい値の調整
   - 線形補間の有効/無効切り替え

3. 進捗表示
   - モデル生成中の進捗バーとステータス表示

## 2. 基本設計

### 2.1 システム構成
- 既存のDICOMアプリケーションに新機能を追加する形で実装
- WPFフレームワークを使用

### 2.2 主要コンポーネント
1. 血管領域選択ツール
2. 血管抽出処理エンジン
3. サーフェスモデル生成エンジン
4. 3Dモデルビューワー

### 2.3 データフロー
1. ユーザーが2D画像ビューワーで血管領域を指定
2. 領域情報をデータ構造として保存
3. ユーザーが血管抽出コマンドを実行
4. 血管抽出処理エンジンが指定された領域を取得
5. サーフェスモデル生成エンジンがモデルを生成
6. 生成されたモデルを3Dビューワーで表示

### 2.4 主要クラス設計
1. `DicomApp.UseCases.BloodVesselRegionSelector`: 血管領域選択ツールの実装
2. `DicomApp.UseCases.BloodVesselExtractionUseCase`: 血管抽出処理のロジック
3. `DicomApp.UseCases.BloodVesselSurfaceModelGenerator`: 抽出された領域からサーフェスモデルを生成
4. `DicomApp.Models.BloodVesselRegion`: 指定された血管領域を表すデータ構造

### 2.5 既存システムの拡張
1. `DicomApp.ViewModels.ImageViewerViewModel`: 領域選択機能の追加
2. `DicomApp.ViewModels.MainWindowViewModel`: 血管抽出コマンドの追加
3. `DicomApp.Views.Model3dViewer`: 抽出されたモデルの表示機能拡張

## 3. 詳細設計

### 3.1 クラス詳細設計

#### 3.1.1 DicomApp.UseCases.BloodVesselRegionSelector
- 責務: 血管領域選択ツールの実装
- 主要メソッド:
  - SelectRegion(DicomImage image): 指定されたDICOM画像上で領域を選択
  - EditRegion(BloodVesselRegion region): 既存の領域を編集
  - DeleteRegion(BloodVesselRegion region): 指定された領域を削除
  - CopyRegionToNextSlice(BloodVesselRegion region): 領域を次のスライスにコピー

#### 3.1.2 DicomApp.UseCases.BloodVesselExtractionUseCase
- 責務: 血管抽出処理のロジック
- 主要メソッド:
  - ExecuteAsync(): 血管抽出処理を非同期で実行
  - GetSelectedRegions(): 選択された血管領域を取得
  - GenerateSurfaceModel(List<BloodVesselRegion> regions): サーフェスモデルを生成

#### 3.1.3 DicomApp.UseCases.BloodVesselSurfaceModelGenerator
- 責務: 抽出された領域からサーフェスモデルを生成
- 主要メソッド:
  - GenerateModel(List<BloodVesselRegion> regions): サーフェスモデルを生成
  - ApplyThreshold(double threshold): しきい値を適用
  - ApplyLinearInterpolation(bool enable): 線形補間の有効/無効を切り替え

#### 3.1.4 DicomApp.Models.BloodVesselRegion
- 責務: 指定された血管領域を表すデータ構造
- プロパティ:
  - int SliceNumber: スライス番号
  - List<Point> Vertices: 多角形の頂点リスト

### 3.2 ユーザーインターフェース詳細設計

#### 3.2.1 血管領域指定ツール
- 多角形描画ツール: マウスクリックで頂点を指定し、ダブルクリックで閉じる
- 編集モード: 既存の頂点をドラッグして移動、右クリックで頂点を削除
- 削除ボタン: 選択された領域を削除
- コピーボタン: 現在のスライスの領域を次のスライスにコピー

#### 3.2.2 抽出設定ダイアログ
- しきい値スライダー: 0-255の範囲で調整可能
- 線形補間チェックボックス: 有効/無効を切り替え
- 適用ボタン: 設定を適用してモデルを再生成
- キャンセルボタン: 変更を破棄してダイアログを閉じる

### 3.3 エラーハンドリング
- 領域選択エラー: 無効な領域（頂点が3つ未満など）が指定された場合、エラーメッセージを表示し、再選択を促す
- モデル生成エラー: メモリ不足や処理エラーが発生した場合、エラーメッセージを表示し、設定の見直しを促す
- ファイル読み込みエラー: DICOMファイルの読み込みに失敗した場合、エラーメッセージを表示し、ファイルの確認を促す

### 3.4 パフォーマンス最適化
- 大規模データセット処理: 大量のスライスを扱う場合、メモリ使用量を監視し、必要に応じて処理をバッチ化する
- モデル生成の並列処理: マルチスレッドを活用し、複数のスライスを同時に処理する
- プログレスバーの更新頻度: 処理の進捗状況を定期的に更新し、UIのレスポンシブ性を維持する

### 3.5 テスト計画
1. 単体テスト
   - BloodVesselRegionSelector: 領域選択、編集、削除機能のテスト
   - BloodVesselSurfaceModelGenerator: モデル生成、しきい値適用、線形補間のテスト

2. 統合テスト
   - 血管抽出プロセス全体のテスト: 領域選択からモデル表示までの一連の流れ
   - 大規模データセットでのパフォーマンステスト

3. ユーザビリティテスト
   - 領域選択ツールの使いやすさ評価
   - 3Dモデル表示の操作性評価

### 3.6 今後の拡張性
- 自動血管検出アルゴリズムの統合
- 複数の血管領域の個別抽出と色分け表示
- 抽出された血管モデルの測定機能（長さ、直径など）

この詳細設計に基づいて実装を進めることで、効率的かつ堅牢な血管抽出サーフェスモデル構築機能を開発することができます。
