# 血管抽出サーフェスモデル構築機能 仕様書

## 1. 概要

この機能は、ユーザーが手動で血管領域を指定し、その領域のみを抽出してサーフェスモデルを構築するものです。これにより、より正確な血管の3Dモデルを生成することが可能になります。

## 2. 機能要件

2.1 血管領域の指定
- ユーザーは2D画像上で血管領域を多角形で指定できる
- 複数のスライスで領域を指定可能
- 指定した領域は保存・編集可能

2.2 血管抽出処理
- 指定された領域内のみでサーフェスモデルを生成
- マーチングキューブ法を使用してモデルを構築
- 線形補間を使用してモデルを構築

2.3 モデル表示
- 生成されたモデルを3Dビューワーで表示
- 回転、ズーム、パンなどの操作が可能

## 3. ユーザーインターフェース

3.1 血管領域指定ツール
- 2D画像ビューワーに多角形描画ツールを追加
- 描画した領域の編集・削除機能
- スライス間での領域のコピー機能

3.2 抽出設定ダイアログ
- しきい値の調整
- 線形補間の有効/無効切り替え

3.3 進捗表示
- モデル生成中の進捗バーとステータス表示

## 4. 設計

4.1 新規クラス
- `DicomApp.UseCases.BloodVesselRegionSelector`: 血管領域選択ツールの実装
- `DicomApp.UseCases.BloodVesselExtractionUseCase`: 血管抽出処理のロジック
- `DicomApp.UseCases.BloodVesselSurfaceModelGenerator`: 抽出された領域からサーフェスモデルを生成

4.2 既存クラスの拡張
- `DicomApp.ViewModels.ImageViewerViewModel`: 領域選択機能の追加
- `DicomApp.ViewModels.MainWindowViewModel`: 血管抽出コマンドの追加
- `DicomApp.Views.Model3dViewer`: 抽出されたモデルの表示機能拡張

4.3 データ構造
- `DicomApp.Models.BloodVesselRegion`: 指定された血管領域を表すクラス
  - スライス番号
  - 多角形の頂点リスト

## 5. 処理フロー

1. ユーザーが2D画像ビューワーで血管領域を指定
2. 領域情報を`BloodVesselRegion`オブジェクトとして保存
3. ユーザーが血管抽出コマンドを実行
4. `BloodVesselExtractionUseCase`が呼び出され、以下の処理を実行:
   1. `BloodVesselRegionSelector`を使用して指定された領域を取得
   2. `BloodVesselSurfaceModelGenerator`を使用してサーフェスモデルを生成
5. 生成されたモデルを`Model3dViewer`で表示

## 6. パフォーマンス考慮事項

- 大量のDICOMスライスを処理する場合、メモリ使用量に注意
- モデル生成処理は非同期で実行し、UIをブロックしないよう配慮
- 処理の進捗状況をユーザーに定期的に通知

## 7. 今後の拡張性

- 自動血管検出アルゴリズムの統合
- 複数の血管領域の個別抽出と色分け表示
- 抽出された血管モデルの測定機能（長さ、直径など）
