# 血管抽出サーフェスモデル構築機能 仕様書

## 1. 概要

この機能は、ユーザーが手動で血管領域を指定し、その領域のみを抽出してサーフェスモデルを構築するものです。これにより、より正確な血管の3Dモデルを生成することが可能になります。

## 2. 機能要件

2.1 血管領域の指定
- ユーザーは2D画像上で血管領域を多角形で指定できる
- 複数のスライスで領域を指定可能
- 指定した領域は保存・編集可能

2.2 血管抽出処理
- 指定された領域内のみでサーフェスモデルを生成
- マーチングキューブ法を使用してモデルを構築
- 線形補間を使用してモデルを構築

2.3 モデル表示
- 生成されたモデルを3Dビューワーで表示
- 回転、ズーム、パンなどの操作が可能

## 3. ユーザーインターフェース

3.1 血管領域指定ツール
- 2D画像ビューワーに多角形描画ツールを追加
- 描画した領域の編集・削除機能
- スライス間での領域のコピー機能

3.2 抽出設定ダイアログ
- しきい値の調整
- 線形補間の有効/無効切り替え

3.3 進捗表示
- モデル生成中の進捗バーとステータス表示

## 4. 設計

4.1 新規クラス
- `DicomApp.UseCases.BloodVesselRegionSelector`: 血管領域選択ツールの実装
- `DicomApp.UseCases.BloodVesselExtractionUseCase`: 血管抽出処理のロジック
- `DicomApp.UseCases.BloodVesselSurfaceModelGenerator`: 抽出された領域からサーフェスモデルを生成

4.2 既存クラスの拡張
- `DicomApp.ViewModels.ImageViewerViewModel`: 領域選択機能の追加
- `DicomApp.ViewModels.MainWindowViewModel`: 血管抽出コマンドの追加
- `DicomApp.Views.Model3dViewer`: 抽出されたモデルの表示機能拡張

4.3 データ構造
- `DicomApp.Models.BloodVesselRegion`: 指定された血管領域を表すクラス
  - スライス番号
  - 多角形の頂点リスト

## 5. 処理フロー

1. ユーザーが2D画像ビューワーで血管領域を指定
2. 領域情報を`BloodVesselRegion`オブジェクトとして保存
3. ユーザーが血管抽出コマンドを実行
4. `BloodVesselExtractionUseCase`が呼び出され、以下の処理を実行:
   1. `BloodVesselRegionSelector`を使用して指定された領域を取得
   2. `BloodVesselSurfaceModelGenerator`を使用してサーフェスモデルを生成
5. 生成されたモデルを`Model3dViewer`で表示

## 6. パフォーマンス考慮事項

- 大量のDICOMスライスを処理する場合、メモリ使用量に注意
- モデル生成処理は非同期で実行し、UIをブロックしないよう配慮
- 処理の進捗状況をユーザーに定期的に通知

## 7. 今後の拡張性

- 自動血管検出アルゴリズムの統合
- 複数の血管領域の個別抽出と色分け表示
- 抽出された血管モデルの測定機能（長さ、直径など）

## 8. 詳細設計

8.1 クラス設計

8.1.1 DicomApp.UseCases.BloodVesselRegionSelector
- 責務: 血管領域選択ツールの実装
- 主要メソッド:
  - SelectRegion(DicomImage image): 指定されたDICOM画像上で領域を選択
  - EditRegion(BloodVesselRegion region): 既存の領域を編集
  - DeleteRegion(BloodVesselRegion region): 指定された領域を削除
  - CopyRegionToNextSlice(BloodVesselRegion region): 領域を次のスライスにコピー

8.1.2 DicomApp.UseCases.BloodVesselExtractionUseCase
- 責務: 血管抽出処理のロジック
- 主要メソッド:
  - ExecuteAsync(): 血管抽出処理を非同期で実行
  - GetSelectedRegions(): 選択された血管領域を取得
  - GenerateSurfaceModel(List<BloodVesselRegion> regions): サーフェスモデルを生成

8.1.3 DicomApp.UseCases.BloodVesselSurfaceModelGenerator
- 責務: 抽出された領域からサーフェスモデルを生成
- 主要メソッド:
  - GenerateModel(List<BloodVesselRegion> regions): サーフェスモデルを生成
  - ApplyThreshold(double threshold): しきい値を適用
  - ApplyLinearInterpolation(bool enable): 線形補間の有効/無効を切り替え

8.1.4 DicomApp.Models.BloodVesselRegion
- 責務: 指定された血管領域を表すデータ構造
- プロパティ:
  - int SliceNumber: スライス番号
  - List<Point> Vertices: 多角形の頂点リスト

8.2 シーケンス図

8.2.1 血管領域選択プロセス
1. ユーザーがImageViewerViewModel上で領域選択を開始
2. ImageViewerViewModelがBloodVesselRegionSelectorを呼び出し
3. BloodVesselRegionSelectorが領域選択UIを表示
4. ユーザーが領域を指定
5. BloodVesselRegionSelectorが選択された領域をBloodVesselRegionオブジェクトとして生成
6. BloodVesselRegionSelectorがImageViewerViewModelに選択された領域を返す
7. ImageViewerViewModelが選択された領域を保存

8.2.2 血管抽出プロセス
1. ユーザーが血管抽出コマンドを実行
2. MainWindowViewModelがBloodVesselExtractionUseCaseを呼び出し
3. BloodVesselExtractionUseCaseがBloodVesselRegionSelectorを使用して選択された領域を取得
4. BloodVesselExtractionUseCaseがBloodVesselSurfaceModelGeneratorを呼び出し
5. BloodVesselSurfaceModelGeneratorがサーフェスモデルを生成
6. BloodVesselExtractionUseCaseが生成されたモデルをModel3dViewerに渡す
7. Model3dViewerが3Dモデルを表示

8.3 ユーザーインターフェース詳細

8.3.1 血管領域指定ツール
- 多角形描画ツール: マウスクリックで頂点を指定し、ダブルクリックで閉じる
- 編集モード: 既存の頂点をドラッグして移動、右クリックで頂点を削除
- 削除ボタン: 選択された領域を削除
- コピーボタン: 現在のスライスの領域を次のスライスにコピー

8.3.2 抽出設定ダイアログ
- しきい値スライダー: 0-255の範囲で調整可能
- 線形補間チェックボックス: 有効/無効を切り替え
- 適用ボタン: 設定を適用してモデルを再生成
- キャンセルボタン: 変更を破棄してダイアログを閉じる

8.4 エラーハンドリング

- 領域選択エラー: 無効な領域（頂点が3つ未満など）が指定された場合、エラーメッセージを表示し、再選択を促す
- モデル生成エラー: メモリ不足や処理エラーが発生した場合、エラーメッセージを表示し、設定の見直しを促す
- ファイル読み込みエラー: DICOMファイルの読み込みに失敗した場合、エラーメッセージを表示し、ファイルの確認を促す

8.5 パフォーマンス最適化

- 大規模データセット処理: 大量のスライスを扱う場合、メモリ使用量を監視し、必要に応じて処理をバッチ化する
- モデル生成の並列処理: マルチスレッドを活用し、複数のスライスを同時に処理する
- プログレスバーの更新頻度: 処理の進捗状況を定期的に更新し、UIのレスポンシブ性を維持する

8.6 テスト計画

8.6.1 単体テスト
- BloodVesselRegionSelector: 領域選択、編集、削除機能のテスト
- BloodVesselSurfaceModelGenerator: モデル生成、しきい値適用、線形補間のテスト

8.6.2 統合テスト
- 血管抽出プロセス全体のテスト: 領域選択からモデル表示までの一連の流れ
- 大規模データセットでのパフォーマンステスト

8.6.3 ユーザビリティテスト
- 領域選択ツールの使いやすさ評価
- 3Dモデル表示の操作性評価

以上の詳細設計を追加することで、血管抽出サーフェスモデル構築機能の実装に必要な情報が提供されます。この設計に基づいて実装を進めることで、効率的かつ堅牢なシステムを構築することができるでしょう。
