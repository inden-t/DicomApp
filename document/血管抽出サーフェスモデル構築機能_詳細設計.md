 # 血管抽出サーフェスモデル構築機能 詳細設計

## 3. 詳細設計

### 3.1 クラス詳細設計

#### 3.1.1 DicomApp.UseCases.BloodVessel3DRegionSelector
- 責務: 3D血管領域選択ツールの実装
- 主要メソッド:
  - SelectRegion(DicomImage3D image): 指定された3D DICOM画像上で領域を選択
  - EditRegion(BloodVessel3DRegion region): 既存の3D領域を編集
  - DeleteRegion(BloodVessel3DRegion region): 指定された3D領域を削除
  - EndSelectionMode(): 選択モードを終了し、すべての選択状態をクリアする

#### 3.1.2 DicomApp.UseCases.BloodVesselExtractionUseCase
- 責務: 血管抽出処理のロジック
- 主要メソッド:
  - ExecuteAsync(): 血管抽出処理を非同期で実行
  - GetSelectedRegions(): 選択された3D血管領域を取得
  - GenerateSurfaceModel(List<BloodVessel3DRegion> regions): サーフェスモデルを生成

#### 3.1.3 DicomApp.UseCases.BloodVesselSurfaceModelGenerator
- 責務: 抽出された3D領域からサーフェスモデルを生成
- 主要メソッド:
  - GenerateModel(List<BloodVessel3DRegion> regions): サーフェスモデルを生成
  - ApplyThreshold(double threshold): しきい値を適用
  - ApplyLinearInterpolation(bool enable): 線形補間の有効/無効を切り替え

#### 3.1.4 DicomApp.Models.BloodVessel3DRegion
- 責務: 指定された3D血管領域を表すデータ構造
- プロパティ:
  - List<Point3D> Vertices: 3D多角形の頂点リスト

#### 3.1.5 DicomApp.Models.SurfaceModel
- 責務: 生成されたサーフェスモデルを表すデータ構造
- プロパティ:
  - List<Triangle3D> Triangles: 3D三角形メッシュのリスト
  - Material ModelMaterial: モデルの材質情報

#### 3.1.6 DicomApp.ViewModels.ProgressViewModel
- 責務: 進捗表示用のViewModel
- プロパティ:
  - double Progress: 現在の進捗率（0-100）
  - string StatusMessage: 現在の処理状態を示すメッセージ
- メソッド:
  - UpdateProgress(double progress, string message): 進捗状況を更新

### 3.2 ユーザーインターフェース詳細設計

#### 3.2.1 リボン上の血管領域指定ツール
- 「血管領域選択」ボタン：クリックで血管領域選択モードを開始/終了
- 「3D塗りつぶし選択」ボタン：クリックで3D塗りつぶし選択モードを開始
- 「しきい値調整」スライダー：3D塗りつぶし選択のしきい値を調整
- 「領域編集」ボタン：クリックで編集モードを開始。既存の頂点をドラッグして移動、右クリックで頂点を削除
- 「領域削除」ボタン：クリックで選択された3D領域を削除
- 「血管抽出」ボタン：クリックで血管抽出処理を開始
- 「キャンセル」ボタン：クリックでモデル生成をキャンセル
- 「モデル保存」ボタン：クリックで生成されたモデルを3Dファイル形式で保存
- 「選択を破棄して終了」ボタン：クリックで血管領域選択モードを終了し、すべての選択状態を破棄

#### 3.2.2 リボン上の抽出設定
- 実行ボタン：設定を適用してモデルを生成
- キャンセルボタン：モデル生成をキャンセル

#### 3.2.3 3Dモデルビューワー
- 3Dモデル表示領域：生成されたサーフェスモデルを表示
- ズーム機能：マウスホイールでモデルをズームイン/アウト
- 回転機能：左クリックドラッグでモデルを回転
- パン機能：右クリックドラッグでモデルを平行移動

#### 3.2.4 進捗表示コンポーネント
- プログレスバー：現在の処理進捗を視覚的に表示
- ステータスメッセージ：現在実行中の処理内容を文字で表示

### 3.3 エラーハンドリング
- 領域選択エラー: 無効な領域（頂点が3つ未満など）が指定された場合、エラーメッセージを表示し、再選択を促す
- モデル生成エラー: メモリ不足や処理エラーが発生した場合、エラーメッセージを表示し、設定の見直しを促す
- ファイル読み込みエラー: DICOMファイルの読み込みに失敗した場合、エラーメッセージを表示し、ファイルの確認を促す

### 3.4 パフォーマンス最適化
- 大規模データセット処理: 大量のスライスを扱う場合、メモリ使用量を監視し、必要に応じて処理をバッチ化する
- モデル生成の並列処理: マルチスレッドを活用し、複数のスライスを同時に処理する
- プログレスバーの更新頻度: 処理の進捗状況を定期的に更新し、UIのレスポンシブ性を維持する

### 3.5 テスト計画
1. 単体テスト
   - BloodVessel3DRegionSelector: 3D領域選択、編集、削除機能のテスト
   - BloodVesselSurfaceModelGenerator: モデル生成、しきい値適用、線形補間のテスト

2. 統合テスト
   - 血管抽出プロセス全体のテスト: 3D領域選択からモデル表示までの一連の流れ
   - 大規模データセットでのパフォーマンステスト

3. ユーザビリティテスト
   - 3D領域選択ツールの使いやすさ評価
   - 3Dモデル表示の操作性評価

## 4. 今後の拡張性

- 2D多角形選択ツールの追加：特定のスライスでより細かい調整が必要な場合に使用
- 自動血管検出アルゴリズムの統合
- 複数の血管領域の個別抽出と色分け表示
- 抽出された血管モデルの測定機能（長さ、直径など）
- 3D領域編集ツールの拡張（例：3Dブラシツール、3Dイレイザーツールなど）

## 5. まとめ

この詳細設計に基づいて実装を進めることで、効率的かつ堅牢な血管抽出サーフェスモデル構築機能を開発することができます。また、将来の拡張性を考慮することで、システムの長期的な価値を高めることができます。
